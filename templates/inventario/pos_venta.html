{% extends "inventario/base.html" %}
{% block title %}POS - Punto de Venta{% endblock %}

{% block content %}
<style>
  /* ---- estilos base (dark-friendly) ---- */
  .tbl { width: 100%; border-collapse: collapse; }
  .tbl th, .tbl td { padding: .9rem 1rem; border-bottom: 1px solid rgba(255,255,255,.08); }
  .tbl th { text-align: left; opacity: .9; font-weight: 600; }
  .tbl td.num { text-align: right; }
  .muted { opacity: .75; }
  .btn-sm { padding: .45rem .75rem; border-radius: .6rem; }
  .btn-soft { background: rgba(255,255,255,.08); }
  .pill { padding: .35rem .6rem; border-radius: 999px; }

  .input { width: 100%; padding: .8rem 1rem; border-radius: .8rem;
           background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.06); color: #fff; }
  .card { border-radius: 1rem; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.06); }
  .card-h { padding: 1rem 1.25rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,.06); }
  .card-b { padding: 1.25rem; }
  .grid2 { display: grid; grid-template-columns: 1fr 380px; gap: 1.25rem; }
  @media (max-width: 1100px) { .grid2 { grid-template-columns: 1fr; } }

  /* ---- Autocomplete ---- */
  .ac-wrap { position: relative; width: 100%; }
  .ac-input { width: 100%; }
  .ac-list { position: absolute; top: calc(100% + 6px); left: 0; right: 0;
             background: rgba(15,23,42,.98); border: 1px solid rgba(255,255,255,.08);
             border-radius: .75rem; max-height: 260px; overflow: auto; z-index: 30;
             box-shadow: 0 14px 34px rgba(0,0,0,.35); display: none; }
  .ac-item { padding: .6rem .85rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,.06); }
  .ac-item:last-child { border-bottom: none; }
  .ac-item.is-active, .ac-item:hover { background: rgba(255,255,255,.08); }
  .kbd { font-size: .75rem; opacity:.75; border:1px solid rgba(255,255,255,.2); padding:.05rem .35rem; border-radius:.4rem; }
</style>

<div class="grid2">
  <!-- IZQUIERDA -->
  <div class="card">
    <div class="card-h">
      <div class="pill btn-soft">Punto de Venta (POS)</div>
      <a class="btn btn-secondary" href="{% url 'inventario:home' %}">Inicio</a>
    </div>

    <div class="card-b">
      <form method="post" id="posForm">
        {% csrf_token %}

        <!-- Buscador con autocompletado + acciones -->
        <div style="display:flex; gap:.6rem; align-items:flex-start; margin-bottom:1rem;">
          <div class="ac-wrap">
            <input id="finderInput" type="text" class="input ac-input"
                   placeholder="Busca por c√≥digo o nombre (p. ej. 'coca', '001'‚Ä¶)"
                   autocomplete="off" />
            <div id="acList" class="ac-list" role="listbox" aria-label="Sugerencias"></div>
          </div>
          <button type="button" id="btnAdd" class="btn btn-primary btn-sm">+ Agregar</button>
          <button type="button" id="btnClear" class="btn btn-secondary btn-sm">Limpiar</button>
        </div>

        <!-- Tabla de l√≠neas -->
        <table class="tbl" id="tblLineas">
          <thead>
            <tr>
              <th style="width:45%;">Producto</th>
              <th style="width:12%;">Cantidad</th>
              <th style="width:18%;">Precio</th>
              <th style="width:18%;">Subtotal</th>
              <th style="width:7%; text-align:center;">Acciones</th>
            </tr>
          </thead>
          <tbody id="bodyLineas"></tbody>
        </table>

        <div style="display:flex; gap:.6rem; margin-top:1.25rem;">
          <button type="submit" class="btn btn-primary">Guardar Venta</button>
        </div>
      </form>
      <div class="muted" style="margin-top:.75rem;">
        <span class="kbd">‚Üë/‚Üì</span> navega ¬∑ <span class="kbd">Enter</span> selecciona ¬∑ <span class="kbd">Esc</span> cierra
      </div>
    </div>
  </div>

  <!-- DERECHA -->
  <div class="card">
    <div class="card-h">Totales</div>
    <div class="card-b">
      <div style="font-size:1.15rem; margin-bottom:.25rem;">Total</div>
      <div id="boxTotal" style="font-size:1.6rem; font-weight:700;">$0</div>

      <div style="margin-top:1rem;" class="muted">
        <ul style="list-style:disc; padding-left:1.25rem; line-height:1.7;">
          <li>Escribe o selecciona un producto y presiona <b>‚Äú+ Agregar‚Äù</b>.</li>
          <li>Edita cantidad o precio; el subtotal y el total se actualizan autom√°ticamente.</li>
          <li>Usa el bot√≥n <b>üóë</b> para eliminar una l√≠nea.</li>
          <li>El stock se descuenta al guardar.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  /* ======= Datos de productos (para el autocomplete y la tabla) ======= */
  const ITEMS = [
    {% for p in productos %}
      { id: {{ p.id }}, label: "{{ p.codigo|escapejs }} - {{ p.nombre|escapejs }}", codigo: "{{ p.codigo|escapejs }}", nombre: "{{ p.nombre|escapejs }}", precio: Number("{{ p.precio }}".replace(',', '.')) || 0 },
    {% endfor %}
  ];

  /* ======= Autocomplete m√≠nimo vanilla ======= */
  const input = document.getElementById('finderInput');
  const list  = document.getElementById('acList');
  const body  = document.getElementById('bodyLineas');
  const totalB= document.getElementById('boxTotal');

  let idxActive = -1;    // √≠ndice resaltado
  let visible = [];      // resultados visibles
  let picked = null;     // √∫ltimo producto seleccionado

  function openList() { list.style.display = visible.length ? 'block' : 'none'; }
  function closeList() { list.style.display = 'none'; idxActive = -1; }

  function renderList() {
    list.innerHTML = '';
    visible.forEach((it, i) => {
      const div = document.createElement('div');
      div.className = 'ac-item' + (i===idxActive ? ' is-active' : '');
      div.textContent = it.label;
      div.role = 'option';
      div.addEventListener('mousedown', (e) => { e.preventDefault(); choose(i); });
      list.appendChild(div);
    });
    openList();
  }

  function filter(q) {
    q = (q||'').trim().toLowerCase();
    if (!q) {
      visible = ITEMS.slice(0, 12);
    } else {
      visible = ITEMS.filter(it =>
        it.nombre.toLowerCase().includes(q) ||
        String(it.codigo).toLowerCase().includes(q)
      ).slice(0, 12);
    }
    idxActive = visible.length ? 0 : -1;
    renderList();
  }

  function choose(i) {
    const it = visible[i];
    if (!it) return;
    picked = it;
    input.value = it.label;
    closeList();
  }

  input.addEventListener('input', () => { picked = null; filter(input.value); });
  input.addEventListener('focus', () => { filter(input.value); openList(); });
  input.addEventListener('blur', () => setTimeout(closeList, 120));

  input.addEventListener('keydown', (e) => {
    if (list.style.display !== 'block') return;
    if (e.key === 'ArrowDown') { e.preventDefault(); if (idxActive < visible.length-1) idxActive++; renderList(); }
    if (e.key === 'ArrowUp')   { e.preventDefault(); if (idxActive > 0) idxActive--; renderList(); }
    if (e.key === 'Enter')     { e.preventDefault(); choose(idxActive); }
    if (e.key === 'Escape')    { e.preventDefault(); closeList(); }
  });

  /* ======= Botones ======= */
  document.getElementById('btnAdd').addEventListener('click', () => {
    // si el usuario no presion√≥ Enter/click, intenta coincidir por texto
    if (!picked) {
      const q = input.value.trim().toLowerCase();
      picked = ITEMS.find(it =>
        it.label.toLowerCase() === q
      ) || ITEMS.find(it =>
        it.nombre.toLowerCase().includes(q) || String(it.codigo).toLowerCase().includes(q)
      );
    }
    if (!picked) return;

    addLine(picked.id, picked.label, picked.precio);
    picked = null;
    input.value = '';
  });

  document.getElementById('btnClear').addEventListener('click', () => {
    body.innerHTML = '';
    updateTotal();
    input.value = '';
    picked = null;
    closeList();
  });

  /* ======= Tabla din√°mica ======= */
  function addLine(productId, label, basePrice) {
    const tr = document.createElement('tr');
    tr.dataset.base = String(basePrice || 0);
    tr.innerHTML = `
      <td>
        <input type="hidden" name="product_id[]" value="${productId}">
        <div>${label}</div>
      </td>
      <td>
        <input type="number" min="1" step="1" name="cantidad[]" value="1" class="input inp-cnt">
      </td>
      <td>
        <input type="number" min="0" step="1" name="precio[]" value="${basePrice||0}" class="input inp-prc">
      </td>
      <td class="num"><span class="subtotal">$0</span></td>
      <td style="text-align:center;">
        <button type="button" class="btn btn-danger btn-sm btn-del" title="Eliminar">üóë</button>
      </td>
    `;
    body.appendChild(tr);
    recalcRow(tr);

    const cnt = tr.querySelector('.inp-cnt');
    const prc = tr.querySelector('.inp-prc');
    cnt.addEventListener('input', () => recalcRow(tr));
    prc.addEventListener('input', () => recalcRow(tr));
    tr.querySelector('.btn-del').addEventListener('click', () => { tr.remove(); updateTotal(); });
  }

  function recalcRow(tr) {
    const cntIn = tr.querySelector('.inp-cnt');
    const prcIn = tr.querySelector('.inp-prc');
    if (prcIn.value === '' || isNaN(parseFloat(prcIn.value))) {
      prcIn.value = tr.dataset.base || '0';
    }
    const c = parseFloat(cntIn.value || 0);
    const p = parseFloat(prcIn.value || 0);
    const s = c * p;
    tr.querySelector('.subtotal').textContent = money(s);
    updateTotal();
  }

  function updateTotal() {
    let t = 0;
    body.querySelectorAll('tr').forEach(tr => {
      const c = parseFloat(tr.querySelector('.inp-cnt').value || 0);
      const p = parseFloat(tr.querySelector('.inp-prc').value || 0);
      t += c * p;
    });
    totalB.textContent = money(t);
  }

  function money(n) {
    return '$' + (Math.round((n || 0))).toLocaleString('es-CL');
  }
</script>
{% endblock %}
